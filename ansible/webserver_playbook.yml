---
- name: Configure Web Server and Deploy MERN App
  hosts: webserver
  become: yes
  tasks:
    # --- APT Packages ---
    - name: Update APT cache
      apt:
        update_cache: yes

    # --- Install Required Packages ---
    - name: Install Git
      apt:
        name: git
        state: present

    - name: Install Nginx
      apt:
        name: nginx
        state: present
        update_cache: yes

    - name: Add Node.js repository
      shell: curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
      become: yes

    - name: Install Node.js and npm
      apt:
        name: nodejs
        state: present

    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes
    
    # --- Application Deployment ---
    - name: Clone TravelMemory app repository
      git:
        repo: 'https://github.com/UnpredictablePrashant/TravelMemory.git'
        dest: /home/ubuntu/TravelMemory
        force: yes
      become: no

    # --- Backend ---
    - name: Install backend dependencies
      npm:
        path: /home/ubuntu/TravelMemory/backend
      become: no

    # --- Frontend ---
    - name: Install frontend dependencies
      npm:
        path: /home/ubuntu/TravelMemory/frontend
      become: no

    # --- Update URL.js to remove hardcoded localhost ---
    - name: Remove hardcoded localhost:3001 from url.js
      replace:
        path: /home/ubuntu/TravelMemory/frontend/src/url.js
        regexp: 'http://localhost:3001'
        replace: ''
      become: no

    # --- Build and Serve Frontend with Nginx ---
    - name: Set frontend API URLs to relative for Nginx proxy
      copy:
        dest: /home/ubuntu/TravelMemory/frontend/.env
        content: |
          REACT_APP_API_URL=/trip
          REACT_APP_BACKEND_URL=/trip
      become: no

    - name: Build React app
      command: npm run build
      args:
        chdir: /home/ubuntu/TravelMemory/frontend
      become: no

    # --- Copy React build to Nginx root ---
    - name: Copy React build to /var/www
      copy:
        src: /home/ubuntu/TravelMemory/frontend/build/
        dest: /var/www/
        owner: www-data
        group: www-data
        mode: '0755'
        remote_src: yes

    # --- Nginx Configuration for reverse proxy ---
    - name: Configure Nginx to serve React frontend and proxy API
      copy:
        dest: /etc/nginx/sites-available/travelmemory
        content: |
          server {
            listen 80;
            server_name _;
            root /var/www;
            index index.html index.htm;

            location /trip/ {
              proxy_pass http://localhost:3001/;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host $host;
              proxy_cache_bypass $http_upgrade;
            }

            location / {
              try_files $uri /index.html;
            }
          }
      notify: Reload Nginx

    # --- Enable Nginx site ---
    - name: Enable Nginx site and remove default
      shell: |
        ln -sf /etc/nginx/sites-available/travelmemory /etc/nginx/sites-enabled/travelmemory
        rm -f /etc/nginx/sites-enabled/default
      notify: Reload Nginx

    # --- Backend Configuration ---
    - name: Create .env file for the backend
      template:
        src: templates/.env.j2
        dest: /home/ubuntu/TravelMemory/backend/.env
      become: no

    - name: Wait for MongoDB to be available
      wait_for:
        host: "{{ hostvars[groups['dbserver'][0]]['inventory_hostname'] }}"
        port: 27017
        delay: 5
        timeout: 60

    - name: Ensure backend listens on 0.0.0.0
      replace:
        path: /home/ubuntu/TravelMemory/backend/index.js
        regexp: "localhost"
        replace: "0.0.0.0"
      become: no

    - name: Start or restart the application with PM2
      shell: pm2 restart /home/ubuntu/TravelMemory/backend/index.js --name TravelMemoryApp || pm2 start /home/ubuntu/TravelMemory/backend/index.js --name TravelMemoryApp
      args:
        chdir: /home/ubuntu/TravelMemory/backend
      become: no
      environment:
        NODE_ENV: production

  handlers:
    - name: Reload Nginx
      service:
        name: nginx
        state: reloaded
